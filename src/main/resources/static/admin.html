<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kupon Bot - Admin Panel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #666;
            font-size: 1.1em;
        }
        
        .section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
        }
        
        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #555;
        }
        
        .table tr:hover {
            background-color: #f8f9fa;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn:hover {
            background: #5a6fd8;
        }
        
        .search-box {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 16px;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        
        .form-grid {
            display: grid;
            gap: 10px;
            margin-top: 15px;
        }
        
        .form-grid input,
        .form-grid textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-grid textarea {
            height: 80px;
            resize: vertical;
        }
        
        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .add-product-form {
            display: none;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }
        
        .date-highlight {
            background: transparent;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: normal;
            color: #333;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
        }
        
        .pagination button {
            padding: 8px 16px;
            border: 1px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .pagination button:hover:not(:disabled) {
            background: #667eea;
            color: white;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination button.active {
            background: #667eea;
            color: white;
            font-weight: bold;
        }
        
        .pagination-info {
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>üõí Ko'zoynak Do'koni - Admin Panel</h1>
                    <p>Mahsulotlar va buyurtmalarni boshqarish</p>
                </div>
                <div>
                    <button onclick="logout()" style="
                        background: #dc3545;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 5px;
                        cursor: pointer;
                        font-size: 14px;
                    ">Chiqish</button>
                </div>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalUsers">-</div>
                <div class="stat-label">Jami foydalanuvchilar</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalProducts">-</div>
                <div class="stat-label">Jami mahsulotlar</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalVouchers">-</div>
                <div class="stat-label">Jami voucherlar</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeVouchers">-</div>
                <div class="stat-label">Faol voucherlar</div>
            </div>
        </div>
        
        <div class="section">
            <h2 class="section-title">üõí Mahsulotlar</h2>
            <div style="margin-bottom: 20px;">
                <button class="btn" onclick="showAddProductForm()" style="background: #28a745;">+ Yangi mahsulot</button>
            </div>
            
            <div id="addProductForm" class="add-product-form">
                <h3>Yangi mahsulot qo'shish</h3>
                <div class="form-grid">
                    <input type="text" id="productName" placeholder="Mahsulot nomi *" required>
                    <textarea id="productDescription" placeholder="Tavsif"></textarea>
                    <input type="number" id="productPrice" placeholder="Narxi (so'm) *" required>
                    <div style="grid-column: 1 / -1;">
                        <label style="display: block; margin-bottom: 10px; font-weight: bold;">Rasm qo'shish:</label>
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                            <label style="flex: 1;">
                                <input type="radio" name="imageType" value="url" checked onchange="toggleImageInput()"> URL orqali
                            </label>
                            <label style="flex: 1;">
                                <input type="radio" name="imageType" value="file" onchange="toggleImageInput()"> Fayl yuklash
                            </label>
                        </div>
                        <div id="urlInputSection" style="display: block;">
                            <textarea id="productImageUrls" placeholder="Rasm URL'larini kiriting (har bir qatorda bitta)&#10;Misol:&#10;https://example.com/image1.jpg&#10;https://example.com/image2.jpg" 
                                style="width: 100%; min-height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace;"></textarea>
                            <small style="color: #666; display: block; margin-top: 5px;">üí° Maksimal 5 ta rasm qo'shishingiz mumkin</small>
                        </div>
                        <div id="fileInputSection" style="display: none;">
                            <label for="productImageFiles" style="display: block; cursor: pointer; padding: 40px; border: 2px dashed #ddd; border-radius: 5px; text-align: center; background: #f9f9f9; transition: all 0.3s;">
                                <div style="font-size: 48px; margin-bottom: 10px;">ÔøΩ</div>
                                <div style="font-size: 16px; color: #666; margin-bottom: 5px;">Rasmlarni tanlash uchun bosing</div>
                                <div style="font-size: 12px; color: #999;">yoki rasmlarni bu yerga sudrab oling</div>
                            </label>
                            <input type="file" id="productImageFiles" accept="image/*" multiple style="display: none;">
                            <small style="color: #666; display: block; margin-top: 10px;">üí° Maksimal 5 ta rasm tanlang (JPG, PNG, GIF)</small>
                            <div id="imagePreview" style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;"></div>
                        </div>
                    </div>
                    <input type="number" id="productStock" placeholder="Stok miqdori *" required>
                </div>
                <div class="form-buttons">
                    <button class="btn" onclick="addProduct()" style="background: #28a745;">Qo'shish</button>
                    <button class="btn" onclick="hideAddProductForm()" style="background: #6c757d;">Bekor qilish</button>
                </div>
            </div>
            
            <input type="text" class="search-box" id="productSearch" placeholder="Mahsulot qidirish...">
            <div id="productsLoading" class="loading">Ma'lumotlar yuklanmoqda...</div>
            <table class="table" id="productsTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Rasm</th>
                        <th>Nomi</th>
                        <th>Narxi</th>
                        <th>Stok</th>
                        <th>Holat</th>
                        <th>Amal</th>
                    </tr>
                </thead>
                <tbody id="productsTableBody">
                </tbody>
            </table>
        </div>
        

        
        <div class="section">
            <h2 class="section-title">üë• Foydalanuvchilar</h2>
            
            <!-- Filter Section -->
            <div style="background: #dbeafe; border: 2px dashed #3b82f6; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                <div style="display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap;">
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <label style="font-size: 13px; font-weight: 600; color: #1e40af;">Yil</label>
                        <select id="yearFilter" style="padding: 10px 16px; border: 2px solid #60a5fa; border-radius: 6px; font-size: 14px; background: white; color: #333; min-width: 140px; cursor: pointer;">
                            <option value="">Yilni tanlang</option>
                        </select>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <label style="font-size: 13px; font-weight: 600; color: #1e40af;">Oy</label>
                        <select id="monthFilter" style="padding: 10px 16px; border: 2px solid #60a5fa; border-radius: 6px; font-size: 14px; background: white; color: #333; min-width: 160px; cursor: pointer;">
                            <option value="">Oyni tanlang</option>
                            <option value="01">01 - Yanvar</option>
                            <option value="02">02 - Fevral</option>
                            <option value="03">03 - Mart</option>
                            <option value="04">04 - Aprel</option>
                            <option value="05">05 - May</option>
                            <option value="06">06 - Iyun</option>
                            <option value="07">07 - Iyul</option>
                            <option value="08">08 - Avgust</option>
                            <option value="09">09 - Sentabr</option>
                            <option value="10">10 - Oktabr</option>
                            <option value="11">11 - Noyabr</option>
                            <option value="12">12 - Dekabr</option>
                        </select>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <label style="font-size: 13px; font-weight: 600; color: #1e40af;">Kun</label>
                        <select id="dayFilter" style="padding: 10px 16px; border: 2px solid #60a5fa; border-radius: 6px; font-size: 14px; background: white; color: #333; min-width: 100px; cursor: pointer;">
                            <option value="">Kunni tanlang</option>
                            <option value="01">01</option>
                            <option value="02">02</option>
                            <option value="03">03</option>
                            <option value="04">04</option>
                            <option value="05">05</option>
                            <option value="06">06</option>
                            <option value="07">07</option>
                            <option value="08">08</option>
                            <option value="09">09</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                            <option value="13">13</option>
                            <option value="14">14</option>
                            <option value="15">15</option>
                            <option value="16">16</option>
                            <option value="17">17</option>
                            <option value="18">18</option>
                            <option value="19">19</option>
                            <option value="20">20</option>
                            <option value="21">21</option>
                            <option value="22">22</option>
                            <option value="23">23</option>
                            <option value="24">24</option>
                            <option value="25">25</option>
                            <option value="26">26</option>
                            <option value="27">27</option>
                            <option value="28">28</option>
                            <option value="29">29</option>
                            <option value="30">30</option>
                            <option value="31">31</option>
                        </select>
                    </div>
                    <button onclick="applyDateFilter()" style="padding: 10px 24px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; height: 42px;">üîç Filtrni qo'llash</button>
                    <button onclick="resetDateFilter()" style="padding: 10px 24px; background: #6b7280; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; height: 42px;">üîÑ Tozalash</button>
                    <button onclick="exportFilteredUsers()" style="padding: 10px 24px; background: #10b981; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; height: 42px; margin-left: 10px;">üìä Excelda yuklab olish</button>
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div style="font-size: 14px; color: #666; font-weight: 500;" id="userResultCount">Jami: <strong>0</strong> ta foydalanuvchi</div>
                <input type="text" class="search-box" id="userSearch" placeholder="Qidirish..." style="max-width: 300px; margin: 0;">
            </div>
            
            <div id="usersLoading" class="loading">Ma'lumotlar yuklanmoqda...</div>
            <table class="table" id="usersTable" style="display: none;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Ism</th>
                        <th>Familiya</th>
                        <th>Username</th>
                        <th>Telefon</th>
                        <th>Tug'ilgan kun</th>
                        <th>Holat</th>
                        <th>Ro'yxatdan o'tgan</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                </tbody>
            </table>
        </div>
        
        <div class="section">
            <h2 class="section-title">üì¢ Barcha foydalanuvchilarga xabar</h2>
            <div style="margin-bottom: 20px;">
                <textarea id="broadcastMessage" placeholder="Barcha foydalanuvchilarga yuboriladigan xabar..." 
                    style="width: 100%; height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; resize: vertical;"></textarea>
                <div style="margin-top: 10px;">
                    <button class="btn" onclick="sendBroadcast()" style="background: #dc3545;">üì¢ Barcha foydalanuvchilarga yuborish</button>
                    <span id="broadcastStatus" style="margin-left: 15px; font-weight: bold;"></span>
                </div>
                <p style="margin-top: 10px; color: #666; font-size: 14px;">
                    ‚ö†Ô∏è Bu xabar barcha ro'yxatdan o'tgan foydalanuvchilarga yuboriladi. Ehtiyot bo'ling!
                </p>
            </div>
        </div>
        
        <div class="section">
            <h2 class="section-title">üë§ Bitta foydalanuvchiga xabar</h2>
            <div style="margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 15px; margin-bottom: 15px;">
                    <input type="number" id="singleUserId" placeholder="Telegram ID (masalan: 123456789)" 
                        style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                    <textarea id="singleUserMessage" placeholder="Foydalanuvchiga yuboriladigan xabar..." 
                        style="height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; resize: vertical;"></textarea>
                </div>
                <div style="margin-top: 10px;">
                    <button class="btn" onclick="sendSingleMessage()" style="background: #007bff;">üë§ Xabar yuborish</button>
                    <button class="btn" onclick="findUserById()" style="background: #28a745; margin-left: 10px;">üîç Foydalanuvchini topish</button>
                    <span id="singleMessageStatus" style="margin-left: 15px; font-weight: bold;"></span>
                </div>
                <div id="foundUserInfo" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; display: none;">
                    <h4>Topilgan foydalanuvchi:</h4>
                    <div id="userDetails"></div>
                </div>
                <p style="margin-top: 10px; color: #666; font-size: 14px;">
                    üí° Foydalanuvchining Telegram ID sini kiritib, unga shaxsiy xabar yuboring. Avval "Foydalanuvchini topish" tugmasini bosib, to'g'ri foydalanuvchi ekanligini tekshiring.
                </p>
            </div>
        </div>
        
        <div class="section">
            <h2 class="section-title">üéüÔ∏è Voucher Boshqaruvi</h2>
            
            <!-- Voucher tekshirish va ishlatish -->
            <div style="margin-bottom: 30px;">
                <h3 style="margin-bottom: 15px;">Voucher Tekshirish va Ishlatish</h3>
                <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 15px; align-items: end; margin-bottom: 15px;">
                    <input type="text" id="voucherCode" placeholder="Voucher kodini kiriting (masalan: a1b2c3d4)" 
                        style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; text-transform: lowercase;">
                    <button class="btn" onclick="checkVoucher()" style="background: #17a2b8;">üîç Tekshirish</button>
                    <button class="btn" onclick="useVoucher()" style="background: #28a745;">‚úÖ Ishlatish</button>
                </div>
                <div id="voucherStatus" style="margin-top: 10px; font-weight: bold;"></div>
                <div id="voucherDetails" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px; display: none;">
                    <h4>Voucher Ma'lumotlari:</h4>
                    <div id="voucherInfo"></div>
                </div>
            </div>
            
            <!-- Barcha voucherlar ro'yxati -->
            <div style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">Barcha Voucherlar</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="btn" onclick="loadAllVouchers()" style="background: #007bff;">üîÑ Yangilash</button>
                    <select id="voucherStatusFilter" onchange="applyVoucherFilter()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Barcha statuslar</option>
                        <option value="ACTIVE">Faol</option>
                        <option value="USED">Ishlatilgan</option>
                        <option value="EXPIRED">Muddati tugagan</option>
                    </select>
                    <select id="voucherTypeFilter" onchange="applyVoucherFilter()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Barcha turlar</option>
                        <option value="BIRTHDAY">Tug'ilgan kun</option>
                        <option value="SPECIAL">Maxsus</option>
                        <option value="ANNIVERSARY">Yubiley</option>
                    </select>
                </div>
                <input type="text" class="search-box" id="voucherSearch" placeholder="Voucher qidirish (kod, foydalanuvchi)..." style="margin-bottom: 15px;" oninput="applyVoucherFilter()">
                
                <div id="vouchersLoading" class="loading">Ma'lumotlar yuklanmoqda...</div>
                <table class="table" id="vouchersTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Kod</th>
                            <th>Foydalanuvchi</th>
                            <th>Miqdor</th>
                            <th>Turi</th>
                            <th>Status</th>
                            <th>Yaratilgan</th>
                            <th>Tugash sanasi</th>
                            <th>Ishlatilgan</th>
                            <th>Amal</th>
                        </tr>
                    </thead>
                    <tbody id="vouchersTableBody">
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="section">
            <h2 class="section-title">üí∞ Keshbek Boshqaruvi</h2>
            
            <!-- Yangi harid qo'shish -->
            <div style="margin-bottom: 30px; background: #e8f5e9; padding: 20px; border-radius: 8px;">
                <h3 style="margin-bottom: 15px;">‚ûï Yangi Harid Qo'shish</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr 2fr auto; gap: 15px; align-items: end;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Telegram ID</label>
                        <input type="number" id="purchaseTelegramId" placeholder="123456789" 
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Harid miqdori (so'm)</label>
                        <input type="number" id="purchaseAmount" placeholder="100000" oninput="calculateCashback()"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Izoh (ixtiyoriy)</label>
                        <input type="text" id="purchaseDescription" placeholder="Ko'zoynak xaridi" 
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                    </div>
                    <button class="btn" onclick="addPurchase()" style="background: #28a745; height: 42px;">Qo'shish</button>
                </div>
                <div id="cashbackCalculation" style="margin-top: 10px; font-size: 14px; color: #2e7d32; font-weight: 600;"></div>
                <div id="purchaseStatus" style="margin-top: 10px; font-weight: bold;"></div>
            </div>
            
            <!-- Foydalanuvchilar keshbek balansi -->
            <div style="margin-bottom: 30px;">
                <h3 style="margin-bottom: 15px;">üë• Foydalanuvchilar Keshbek Balansi</h3>
                <button class="btn" onclick="loadCashbackBalances()" style="background: #007bff; margin-bottom: 15px;">üîÑ Yangilash</button>
                <div id="balancesLoading" class="loading" style="display: none;">Ma'lumotlar yuklanmoqda...</div>
                <table class="table" id="balancesTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Telegram ID</th>
                            <th>Ism</th>
                            <th>Telefon</th>
                            <th>Joriy balans</th>
                            <th>Jami olingan</th>
                            <th>Jami ishlatilgan</th>
                        </tr>
                    </thead>
                    <tbody id="balancesTableBody">
                    </tbody>
                </table>
            </div>
            
            <!-- Keshbek tarixi -->
            <div style="margin-bottom: 30px;">
                <h3 style="margin-bottom: 15px;">üìú Keshbek Tarixi</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="btn" onclick="loadCashbackHistory()" style="background: #007bff;">üîÑ Yangilash</button>
                    <select id="historyTypeFilter" onchange="applyCashbackHistoryFilter()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Barcha turlar</option>
                        <option value="EARNED">Olingan</option>
                        <option value="USED">Ishlatilgan</option>
                        <option value="REFUNDED">Qaytarilgan</option>
                    </select>
                    <input type="text" id="historySearch" placeholder="Qidirish..." oninput="applyCashbackHistoryFilter()"
                        style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; flex: 1;">
                </div>
                <div id="historyLoading" class="loading" style="display: none;">Ma'lumotlar yuklanmoqda...</div>
                <table class="table" id="historyTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Sana</th>
                            <th>Foydalanuvchi</th>
                            <th>Turi</th>
                            <th>Harid</th>
                            <th>Keshbek</th>
                            <th>Izoh</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                    </tbody>
                </table>
            </div>
            
            <!-- Keshbek ishlatish/qaytarish -->
            <div style="background: #fff3cd; padding: 20px; border-radius: 8px;">
                <h3 style="margin-bottom: 15px;">‚öôÔ∏è Keshbek Ishlatish / Qaytarish</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr 2fr auto auto; gap: 15px; align-items: end;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Telegram ID</label>
                        <input type="number" id="actionTelegramId" placeholder="123456789" 
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Miqdor (so'm)</label>
                        <input type="number" id="actionAmount" placeholder="5000" 
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Izoh</label>
                        <input type="text" id="actionDescription" placeholder="Sabab" 
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                    </div>
                    <button class="btn" onclick="useCashback()" style="background: #dc3545; height: 42px;">Ishlatish</button>
                    <button class="btn" onclick="refundCashback()" style="background: #28a745; height: 42px;">Qaytarish</button>
                </div>
                <div id="actionStatus" style="margin-top: 10px; font-weight: bold;"></div>
                <p style="margin-top: 10px; color: #856404; font-size: 13px;">
                    ‚ö†Ô∏è <strong>Ishlatish:</strong> Foydalanuvchi balansidan keshbek ayiriladi. <strong>Qaytarish:</strong> Foydalanuvchi balansiga keshbek qo'shiladi.
                </p>
            </div>
        </div>
    </div>

    <script>
        // Check authentication first
        if (localStorage.getItem('adminAuth') !== 'true') {
            window.location.href = '/login.html';
        }
        
        // API base URL (Local development)
        const API_BASE = '/api/admin';
        
        // Pagination settings
        const ITEMS_PER_PAGE = 20;
        let currentUserPage = 1;
        let currentBalancePage = 1;
        let currentHistoryPage = 1;
        
        // Store all users and filtered users
        let allUsers = [];
        let filteredUsers = [];
        
        // Helper function for API calls with bypass headers
        async function apiCall(url, options = {}) {
            const defaultHeaders = {
                'bypass-tunnel-reminder': 'true',
                'User-Agent': 'KuponBot-Admin/1.0',
                'Content-Type': 'application/json'
            };
            
            const mergedOptions = {
                ...options,
                headers: {
                    ...defaultHeaders,
                    ...options.headers
                }
            };
            
            return fetch(url, mergedOptions);
        }
        
        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadProducts();
            loadUsers();
            loadAllVouchers();
            populateYearFilter(); // Yil filtrini avtomatik to'ldirish
        });
        
        // Populate year filter dynamically
        function populateYearFilter() {
            const yearSelect = document.getElementById('yearFilter');
            const currentYear = new Date().getFullYear();
            const startYear = 2020; // Boshlang'ich yil
            
            // Joriy yildan boshlab 2020 yilgacha
            for (let year = currentYear; year >= startYear; year--) {
                const option = document.createElement('option');
                option.value = year.toString();
                option.textContent = year.toString();
                yearSelect.appendChild(option);
            }
        }
        
        // Load statistics
        async function loadStats() {
            try {
                const response = await apiCall(`${API_BASE}/stats`);
                const stats = await response.json();
                
                document.getElementById('totalUsers').textContent = stats.totalUsers;
                document.getElementById('totalProducts').textContent = stats.totalProducts;
                document.getElementById('totalVouchers').textContent = stats.totalVouchers || 0;
                document.getElementById('activeVouchers').textContent = stats.activeVouchers || 0;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        // Show add product form
        function showAddProductForm() {
            const form = document.getElementById('addProductForm');
            if (form) {
                form.style.display = 'block';
            }
        }
        
        // Hide add product form
        function hideAddProductForm() {
            document.getElementById('addProductForm').style.display = 'none';
            // Clear form
            document.getElementById('productName').value = '';
            document.getElementById('productDescription').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productImageUrls').value = '';
            document.getElementById('productImageFiles').value = '';
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('productStock').value = '';
        }
        
        // Toggle between URL and file input
        function toggleImageInput() {
            const imageType = document.querySelector('input[name="imageType"]:checked').value;
            const urlSection = document.getElementById('urlInputSection');
            const fileSection = document.getElementById('fileInputSection');
            const fileInput = document.getElementById('productImageFiles');
            
            if (imageType === 'url') {
                urlSection.style.display = 'block';
                fileSection.style.display = 'none';
            } else {
                urlSection.style.display = 'none';
                fileSection.style.display = 'block';
                
                // Setup file input handler
                setupFileInput();
            }
        }
        
        // Setup file input with preview
        function setupFileInput() {
            const fileInput = document.getElementById('productImageFiles');
            const preview = document.getElementById('imagePreview');
            const label = fileInput.previousElementSibling;
            
            // Click on label opens file picker
            label.onclick = function() {
                fileInput.click();
            };
            
            // Handle file selection
            fileInput.onchange = function(e) {
                preview.innerHTML = '';
                
                const files = Array.from(e.target.files).slice(0, 5); // Max 5 files
                
                if (files.length === 0) return;
                
                files.forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const container = document.createElement('div');
                        container.style.position = 'relative';
                        container.style.display = 'inline-block';
                        
                        const img = document.createElement('img');
                        img.src = event.target.result;
                        img.style.width = '100px';
                        img.style.height = '100px';
                        img.style.objectFit = 'cover';
                        img.style.borderRadius = '5px';
                        img.style.border = '2px solid #28a745';
                        
                        const badge = document.createElement('div');
                        badge.textContent = index + 1;
                        badge.style.position = 'absolute';
                        badge.style.top = '5px';
                        badge.style.right = '5px';
                        badge.style.background = '#28a745';
                        badge.style.color = 'white';
                        badge.style.width = '24px';
                        badge.style.height = '24px';
                        badge.style.borderRadius = '50%';
                        badge.style.display = 'flex';
                        badge.style.alignItems = 'center';
                        badge.style.justifyContent = 'center';
                        badge.style.fontSize = '12px';
                        badge.style.fontWeight = 'bold';
                        
                        container.appendChild(img);
                        container.appendChild(badge);
                        preview.appendChild(container);
                    };
                    reader.readAsDataURL(file);
                });
                
                // Update label text
                label.querySelector('div:nth-child(2)').textContent = `${files.length} ta rasm tanlandi`;
            };
            
            // Drag and drop support
            label.ondragover = function(e) {
                e.preventDefault();
                label.style.borderColor = '#28a745';
                label.style.background = '#f0f8f0';
            };
            
            label.ondragleave = function(e) {
                e.preventDefault();
                label.style.borderColor = '#ddd';
                label.style.background = '#f9f9f9';
            };
            
            label.ondrop = function(e) {
                e.preventDefault();
                label.style.borderColor = '#ddd';
                label.style.background = '#f9f9f9';
                
                const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/')).slice(0, 5);
                
                // Create a new FileList-like object
                const dataTransfer = new DataTransfer();
                files.forEach(file => dataTransfer.items.add(file));
                fileInput.files = dataTransfer.files;
                
                // Trigger change event
                fileInput.dispatchEvent(new Event('change'));
            };
        }
        
        // Add product
        async function addProduct() {
            const name = document.getElementById('productName').value;
            const description = document.getElementById('productDescription').value;
            const price = document.getElementById('productPrice').value;
            const stockQuantity = document.getElementById('productStock').value;
            const imageType = document.querySelector('input[name="imageType"]:checked').value;
            
            if (!name || !price || !stockQuantity) {
                alert('Iltimos, majburiy maydonlarni to\'ldiring (*, narx, stok)');
                return;
            }
            
            let imageUrls = [];
            
            // Handle image based on type
            if (imageType === 'url') {
                // Ko'p URL'larni olish va tozalash
                const imageUrlsText = document.getElementById('productImageUrls').value;
                imageUrls = imageUrlsText
                    .split('\n')
                    .map(url => url.trim())
                    .filter(url => url.length > 0 && url.startsWith('http'))
                    .slice(0, 5); // Maksimal 5 ta rasm
                
                console.log('Parsed URLs:', imageUrls); // Debug
            } else {
                // Handle file upload
                const fileInput = document.getElementById('productImageFiles');
                const files = Array.from(fileInput.files).slice(0, 5);
                
                if (files.length > 0) {
                    // Convert images to base64
                    const promises = files.map(file => {
                        return new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                resolve(e.target.result);
                            };
                            reader.readAsDataURL(file);
                        });
                    });
                    
                    imageUrls = await Promise.all(promises);
                    console.log('Converted files:', imageUrls.length); // Debug
                }
            }
            
            if (imageUrls.length === 0) {
                alert('Iltimos, kamida bitta rasm qo\'shing!');
                return;
            }
            
            console.log('Final imageUrls:', imageUrls); // Debug
            
            try {
                const response = await apiCall(`${API_BASE}/products`, {
                    method: 'POST',
                    body: JSON.stringify({
                        name: name,
                        description: description,
                        price: price,
                        imageUrls: imageUrls, // Ko'p rasmlar
                        stockQuantity: parseInt(stockQuantity)
                    })
                });
                
                if (response.ok) {
                    alert('Mahsulot muvaffaqiyatli qo\'shildi!');
                    hideAddProductForm();
                    loadStats();
                    loadProducts();
                } else {
                    const error = await response.text();
                    console.error('Server error:', error);
                    alert('Xatolik yuz berdi: ' + error);
                }
            } catch (error) {
                console.error('Error adding product:', error);
                alert('Xatolik yuz berdi!');
            }
        }
        
        // Load products
        async function loadProducts() {
            try {
                const response = await apiCall(`${API_BASE}/products`);
                const products = await response.json();
                
                const tbody = document.getElementById('productsTableBody');
                tbody.innerHTML = '';
                
                products.forEach(product => {
                    const row = document.createElement('tr');
                    const firstImage = product.imageUrls && product.imageUrls.length > 0 ? product.imageUrls[0] : null;
                    const imageCount = product.imageUrls ? product.imageUrls.length : 0;
                    
                    row.innerHTML = `
                        <td>
                            ${firstImage ? 
                                `<div style="position: relative;">
                                    <img src="${firstImage}" alt="${product.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">
                                    ${imageCount > 1 ? `<span style="position: absolute; bottom: 2px; right: 2px; background: rgba(0,0,0,0.7); color: white; padding: 2px 5px; border-radius: 3px; font-size: 10px;">+${imageCount-1}</span>` : ''}
                                </div>` : 
                                'üëì'
                            }
                        </td>
                        <td>${product.name}</td>
                        <td>${formatPrice(product.price)} so'm</td>
                        <td>${product.stockQuantity}</td>
                        <td>${product.status === 'ACTIVE' ? '‚úÖ Faol' : '‚ùå Nofaol'}</td>
                        <td>
                            <button class="btn" onclick="deleteProduct(${product.id})" style="background: #dc3545; font-size: 12px; padding: 5px 10px;">O'chirish</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                document.getElementById('productsLoading').style.display = 'none';
                document.getElementById('productsTable').style.display = 'table';
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('productsLoading').textContent = 'Xatolik yuz berdi';
            }
        }
        
        // Delete product
        async function deleteProduct(id) {
            if (!confirm('Bu mahsulotni o\'chirish tasdiqlaysizmi?')) {
                return;
            }
            
            try {
                const response = await apiCall(`${API_BASE}/products/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('Mahsulot o\'chirildi!');
                    loadStats();
                    loadProducts();
                } else {
                    alert('Xatolik yuz berdi!');
                }
            } catch (error) {
                console.error('Error deleting product:', error);
                alert('Xatolik yuz berdi!');
            }
        }
        

        
        // Load users
        async function loadUsers(filter = 'all') {
            try {
                let url = `${API_BASE}/users`;
                if (filter !== 'all') {
                    url = `${API_BASE}/users-filtered?filter=${filter}`;
                }
                
                const response = await apiCall(url);
                const users = await response.json();
                
                allUsers = users;
                filteredUsers = [...users];
                displayUsers(filteredUsers);
                
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersLoading').textContent = 'Xatolik yuz berdi';
            }
        }
        
        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';
            
            const resultCount = document.getElementById('userResultCount');
            resultCount.innerHTML = `Jami: <strong>${users.length}</strong> ta foydalanuvchi`;
            
            // Calculate pagination
            const totalPages = Math.ceil(users.length / ITEMS_PER_PAGE);
            const startIndex = (currentUserPage - 1) * ITEMS_PER_PAGE;
            const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, users.length);
            const paginatedUsers = users.slice(startIndex, endIndex);
            
            paginatedUsers.forEach(user => {
                const row = document.createElement('tr');
                
                // Parse createdAt date
                const createdDate = new Date(user.createdAt);
                const formattedDate = `${String(createdDate.getDate()).padStart(2, '0')}/${String(createdDate.getMonth() + 1).padStart(2, '0')}/${createdDate.getFullYear()}`;
                
                row.innerHTML = `
                    <td>${user.telegramId}</td>
                    <td>${user.firstName || '-'}</td>
                    <td>${user.lastName || '-'}</td>
                    <td>${user.telegramUsername || 'Username yo\'q'}</td>
                    <td>${user.phoneNumber || '-'}</td>
                    <td>${user.birthDate || 'Kiritilmagan'}</td>
                    <td>${user.state}</td>
                    <td><span class="date-highlight">${formattedDate}</span></td>
                `;
                tbody.appendChild(row);
            });
            
            document.getElementById('usersLoading').style.display = 'none';
            document.getElementById('usersTable').style.display = 'table';
            
            // Add pagination controls
            renderUserPagination(totalPages, users.length, startIndex, endIndex);
        }
        
        function renderUserPagination(totalPages, totalItems, startIndex, endIndex) {
            let paginationDiv = document.getElementById('userPagination');
            if (!paginationDiv) {
                paginationDiv = document.createElement('div');
                paginationDiv.id = 'userPagination';
                paginationDiv.className = 'pagination';
                document.getElementById('usersTable').parentNode.appendChild(paginationDiv);
            }
            
            if (totalPages <= 1) {
                paginationDiv.style.display = 'none';
                return;
            }
            
            paginationDiv.style.display = 'flex';
            paginationDiv.innerHTML = `
                <button onclick="changeUserPage(1)" ${currentUserPage === 1 ? 'disabled' : ''}>‚èÆÔ∏è Birinchi</button>
                <button onclick="changeUserPage(${currentUserPage - 1})" ${currentUserPage === 1 ? 'disabled' : ''}>‚óÄÔ∏è Oldingi</button>
                <span class="pagination-info">${startIndex + 1}-${endIndex} / ${totalItems}</span>
                <button onclick="changeUserPage(${currentUserPage + 1})" ${currentUserPage === totalPages ? 'disabled' : ''}>Keyingi ‚ñ∂Ô∏è</button>
                <button onclick="changeUserPage(${totalPages})" ${currentUserPage === totalPages ? 'disabled' : ''}>Oxirgi ‚è≠Ô∏è</button>
            `;
        }
        
        function changeUserPage(page) {
            currentUserPage = page;
            displayUsers(filteredUsers);
        }
        
        // Apply date filter
        function applyDateFilter() {
            const year = document.getElementById('yearFilter').value;
            const month = document.getElementById('monthFilter').value;
            const day = document.getElementById('dayFilter').value;
            
            if (!year && !month && !day) {
                alert('Iltimos, kamida bitta filtrni tanlang!');
                return;
            }
            
            filteredUsers = allUsers.filter(user => {
                const createdDate = new Date(user.createdAt);
                const userDay = String(createdDate.getDate()).padStart(2, '0');
                const userMonth = String(createdDate.getMonth() + 1).padStart(2, '0');
                const userYear = createdDate.getFullYear().toString();
                
                let match = true;
                if (year && userYear !== year) match = false;
                if (month && userMonth !== month) match = false;
                if (day && userDay !== day) match = false;
                
                return match;
            });
            
            currentUserPage = 1; // Reset to first page
            displayUsers(filteredUsers);
        }
        
        // Reset date filter
        function resetDateFilter() {
            document.getElementById('yearFilter').value = '';
            document.getElementById('monthFilter').value = '';
            document.getElementById('dayFilter').value = '';
            filteredUsers = [...allUsers];
            currentUserPage = 1; // Reset to first page
            displayUsers(filteredUsers);
        }
        
        // Export filtered users to Excel
        function exportFilteredUsers() {
            if (filteredUsers.length === 0) {
                alert('Eksport qilish uchun ma\'lumot yo\'q!');
                return;
            }
            
            // Prepare data
            const data = [
                ['ID', 'Ism', 'Familiya', 'Username', 'Telefon', 'Tug\'ilgan kun', 'Holat', 'Ro\'yxatdan o\'tgan']
            ];
            
            filteredUsers.forEach(user => {
                const createdDate = new Date(user.createdAt);
                const formattedDate = `${String(createdDate.getDate()).padStart(2, '0')}/${String(createdDate.getMonth() + 1).padStart(2, '0')}/${createdDate.getFullYear()}`;
                
                data.push([
                    user.telegramId,
                    user.firstName || '-',
                    user.lastName || '-',
                    user.telegramUsername || 'Username yo\'q',
                    user.phoneNumber || '-',
                    user.birthDate || 'Kiritilmagan',
                    user.state,
                    formattedDate
                ]);
            });
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Set column widths
            ws['!cols'] = [
                { wch: 12 }, // ID
                { wch: 15 }, // Ism
                { wch: 15 }, // Familiya
                { wch: 18 }, // Username
                { wch: 15 }, // Telefon
                { wch: 15 }, // Tug'ilgan kun
                { wch: 12 }, // Holat
                { wch: 18 }  // Ro'yxatdan o'tgan
            ];
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Foydalanuvchilar');
            
            // Generate filename
            const today = new Date();
            const filename = `foydalanuvchilar_${today.getFullYear()}_${String(today.getMonth()+1).padStart(2,'0')}_${String(today.getDate()).padStart(2,'0')}.xlsx`;
            
            // Save file
            XLSX.writeFile(wb, filename);
        }
        
        // Helper functions
        function formatPrice(price) {
            return new Intl.NumberFormat('uz-UZ').format(price);
        }
        
        function getOrderStatusText(status) {
            const statusMap = {
                'PENDING': '‚è≥ Kutilmoqda',
                'CONFIRMED': '‚úÖ Tasdiqlangan',
                'PREPARING': 'üîÑ Tayyorlanmoqda',
                'SHIPPED': 'üöö Yuborilgan',
                'DELIVERED': '‚úÖ Yetkazilgan',
                'CANCELLED': '‚ùå Bekor qilingan'
            };
            return statusMap[status] || status;
        }
        
        // Logout function
        function logout() {
            if (confirm('Admin paneldan chiqishni xohlaysizmi?')) {
                localStorage.removeItem('adminAuth');
                window.location.href = '/login.html';
            }
        }
        
        // Search functionality
        document.getElementById('productSearch').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#productsTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });
        

        
        document.getElementById('userSearch').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            
            if (!searchTerm) {
                currentUserPage = 1;
                displayUsers(filteredUsers);
                return;
            }
            
            const searchResults = filteredUsers.filter(user => {
                const searchString = `${user.telegramId} ${user.firstName} ${user.lastName} ${user.telegramUsername} ${user.phoneNumber}`.toLowerCase();
                return searchString.includes(searchTerm);
            });
            
            currentUserPage = 1;
            displayUsers(searchResults);
        });
        
        // Send broadcast message
        async function sendBroadcast() {
            const message = document.getElementById('broadcastMessage').value.trim();
            const statusElement = document.getElementById('broadcastStatus');
            
            if (!message) {
                alert('‚ùå Iltimos, xabar matnini kiriting!');
                return;
            }
            
            if (!confirm('Haqiqatan ham barcha foydalanuvchilarga xabar yuborishni xohlaysizmi?')) {
                return;
            }
            
            try {
                statusElement.textContent = 'üì§ Yuborilmoqda...';
                statusElement.style.color = '#007bff';
                
                const response = await apiCall(`${API_BASE}/broadcast`, {
                    method: 'POST',
                    body: JSON.stringify({ message: message })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    statusElement.innerHTML = `
                        ‚úÖ Yuborildi: ${result.successCount}/${result.totalUsers} 
                        (${result.successRate.toFixed(1)}%)
                        ${result.failureCount > 0 ? `‚ùå Xatolik: ${result.failureCount}` : ''}
                    `;
                    statusElement.style.color = '#28a745';
                    
                    // Clear message after successful send
                    document.getElementById('broadcastMessage').value = '';
                    
                    alert(`‚úÖ Xabar muvaffaqiyatli yuborildi!\n\nJami: ${result.totalUsers}\nMuvaffaqiyatli: ${result.successCount}\nXatolik: ${result.failureCount}`);
                } else {
                    statusElement.textContent = '‚ùå Xatolik yuz berdi';
                    statusElement.style.color = '#dc3545';
                    alert('‚ùå Xatolik yuz berdi: ' + response.statusText);
                }
            } catch (error) {
                console.error('Error sending broadcast:', error);
                statusElement.textContent = '‚ùå Xatolik yuz berdi';
                statusElement.style.color = '#dc3545';
                alert('‚ùå Xatolik yuz berdi: ' + error.message);
            }
        }
        
        // Find user by Telegram ID
        async function findUserById() {
            const telegramId = document.getElementById('singleUserId').value.trim();
            const statusElement = document.getElementById('singleMessageStatus');
            const userInfoDiv = document.getElementById('foundUserInfo');
            const userDetailsDiv = document.getElementById('userDetails');
            
            if (!telegramId) {
                alert('‚ùå Iltimos, Telegram ID ni kiriting!');
                return;
            }
            
            try {
                statusElement.textContent = 'üîç Qidirilmoqda...';
                statusElement.style.color = '#007bff';
                userInfoDiv.style.display = 'none';
                
                const response = await apiCall(`${API_BASE}/find-user/${telegramId}`);
                
                if (response.ok) {
                    const user = await response.json();
                    statusElement.textContent = '‚úÖ Foydalanuvchi topildi!';
                    statusElement.style.color = '#28a745';
                    
                    // Display user info
                    userDetailsDiv.innerHTML = `
                        <p><strong>ID:</strong> ${user.telegramId}</p>
                        <p><strong>Ism:</strong> ${user.firstName || '-'}</p>
                        <p><strong>Familiya:</strong> ${user.lastName || '-'}</p>
                        <p><strong>Username:</strong> ${user.telegramUsername || 'Username yo\'q'}</p>
                        <p><strong>Telefon:</strong> ${user.phoneNumber || '-'}</p>
                        <p><strong>Tug\'ilgan kun:</strong> ${user.birthDate || 'Kiritilmagan'}</p>
                        <p><strong>Holat:</strong> ${user.state}</p>
                        <p><strong>Ro\'yxatdan o\'tgan:</strong> ${new Date(user.createdAt).toLocaleDateString('uz-UZ')}</p>
                    `;
                    userInfoDiv.style.display = 'block';
                    
                } else if (response.status === 404) {
                    statusElement.textContent = '‚ùå Foydalanuvchi topilmadi';
                    statusElement.style.color = '#dc3545';
                    userInfoDiv.style.display = 'none';
                } else {
                    statusElement.textContent = '‚ùå Xatolik yuz berdi';
                    statusElement.style.color = '#dc3545';
                    userInfoDiv.style.display = 'none';
                }
            } catch (error) {
                console.error('Error finding user:', error);
                statusElement.textContent = '‚ùå Xatolik yuz berdi';
                statusElement.style.color = '#dc3545';
                userInfoDiv.style.display = 'none';
            }
        }
        
        // Send message to single user
        async function sendSingleMessage() {
            const telegramId = document.getElementById('singleUserId').value.trim();
            const message = document.getElementById('singleUserMessage').value.trim();
            const statusElement = document.getElementById('singleMessageStatus');
            
            if (!telegramId) {
                alert('‚ùå Iltimos, Telegram ID ni kiriting!');
                return;
            }
            
            if (!message) {
                alert('‚ùå Iltimos, xabar matnini kiriting!');
                return;
            }
            
            if (!confirm(`Haqiqatan ham ${telegramId} ID li foydalanuvchiga xabar yuborishni xohlaysizmi?`)) {
                return;
            }
            
            try {
                statusElement.textContent = 'üì§ Yuborilmoqda...';
                statusElement.style.color = '#007bff';
                
                const response = await apiCall(`${API_BASE}/send-single-message`, {
                    method: 'POST',
                    body: JSON.stringify({ 
                        telegramId: telegramId,
                        message: message 
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    statusElement.textContent = '‚úÖ Xabar muvaffaqiyatli yuborildi!';
                    statusElement.style.color = '#28a745';
                    
                    // Clear message after successful send
                    document.getElementById('singleUserMessage').value = '';
                    
                    alert('‚úÖ Xabar muvaffaqiyatli yuborildi!');
                } else if (response.status === 404) {
                    statusElement.textContent = '‚ùå Foydalanuvchi topilmadi';
                    statusElement.style.color = '#dc3545';
                    alert('‚ùå Foydalanuvchi topilmadi yoki ro\'yxatdan o\'tmagan');
                } else {
                    statusElement.textContent = '‚ùå Xatolik yuz berdi';
                    statusElement.style.color = '#dc3545';
                    alert('‚ùå Xatolik yuz berdi: ' + response.statusText);
                }
            } catch (error) {
                console.error('Error sending single message:', error);
                statusElement.textContent = '‚ùå Xatolik yuz berdi';
                statusElement.style.color = '#dc3545';
                alert('‚ùå Xatolik yuz berdi: ' + error.message);
            }
        }
        
        // Voucher Functions
        async function checkVoucher() {
            const code = document.getElementById('voucherCode').value.trim().toLowerCase();
            const statusElement = document.getElementById('voucherStatus');
            const detailsDiv = document.getElementById('voucherDetails');
            const infoDiv = document.getElementById('voucherInfo');
            
            if (!code) {
                alert('‚ùå Iltimos, voucher kodini kiriting!');
                return;
            }
            
            try {
                statusElement.textContent = 'üîç Tekshirilmoqda...';
                statusElement.style.color = '#007bff';
                detailsDiv.style.display = 'none';
                
                const response = await apiCall(`${API_BASE}/vouchers/${code}`);
                
                if (response.ok) {
                    const voucher = await response.json();
                    statusElement.textContent = '‚úÖ Voucher topildi!';
                    statusElement.style.color = '#28a745';
                    
                    // Voucher ma'lumotlarini ko'rsatish
                    const statusText = getVoucherStatusText(voucher.status);
                    const typeText = getVoucherTypeText(voucher.type);
                    const expiryInfo = voucher.status === 'ACTIVE' ? 
                        `‚è∞ ${voucher.daysUntilExpiry} kun qoldi` : '';
                    
                    infoDiv.innerHTML = `
                        <p><strong>Kod:</strong> ${voucher.code}</p>
                        <p><strong>Foydalanuvchi:</strong> ${voucher.userFullName} (ID: ${voucher.userTelegramId})</p>
                        <p><strong>Miqdor:</strong> ${formatPrice(voucher.amount)} so'm</p>
                        <p><strong>Turi:</strong> ${typeText}</p>
                        <p><strong>Status:</strong> ${statusText} ${expiryInfo}</p>
                        <p><strong>Yaratilgan:</strong> ${new Date(voucher.createdAt).toLocaleDateString('uz-UZ')}</p>
                        <p><strong>Tugash sanasi:</strong> ${new Date(voucher.expiresAt).toLocaleDateString('uz-UZ')}</p>
                        ${voucher.usedAt ? `<p><strong>Ishlatilgan:</strong> ${new Date(voucher.usedAt).toLocaleDateString('uz-UZ')}</p>` : ''}
                    `;
                    detailsDiv.style.display = 'block';
                    
                } else if (response.status === 404) {
                    statusElement.textContent = '‚ùå Voucher topilmadi';
                    statusElement.style.color = '#dc3545';
                    detailsDiv.style.display = 'none';
                } else {
                    statusElement.textContent = '‚ùå Xatolik yuz berdi';
                    statusElement.style.color = '#dc3545';
                    detailsDiv.style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking voucher:', error);
                statusElement.textContent = '‚ùå Xatolik yuz berdi';
                statusElement.style.color = '#dc3545';
                detailsDiv.style.display = 'none';
            }
        }
        
        async function useVoucher() {
            const code = document.getElementById('voucherCode').value.trim().toLowerCase();
            const statusElement = document.getElementById('voucherStatus');
            
            if (!code) {
                alert('‚ùå Iltimos, voucher kodini kiriting!');
                return;
            }
            
            if (!confirm(`Haqiqatan ham ${code} voucherni ishlatildi deb belgilashni xohlaysizmi?`)) {
                return;
            }
            
            try {
                statusElement.textContent = '‚è≥ Ishlatilmoqda...';
                statusElement.style.color = '#007bff';
                
                const response = await apiCall(`${API_BASE}/vouchers/${code}/use`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const voucher = await response.json();
                    statusElement.textContent = '‚úÖ Voucher muvaffaqiyatli ishlatildi!';
                    statusElement.style.color = '#28a745';
                    
                    // Ma'lumotlarni yangilash
                    checkVoucher();
                    loadStats();
                    loadAllVouchers();
                    
                    alert('‚úÖ Voucher muvaffaqiyatli ishlatildi!');
                } else if (response.status === 404) {
                    statusElement.textContent = '‚ùå Voucher topilmadi';
                    statusElement.style.color = '#dc3545';
                } else {
                    statusElement.textContent = '‚ùå Voucher ishlatib bo\'lmaydi (faol emas yoki muddati tugagan)';
                    statusElement.style.color = '#dc3545';
                }
            } catch (error) {
                console.error('Error using voucher:', error);
                statusElement.textContent = '‚ùå Xatolik yuz berdi';
                statusElement.style.color = '#dc3545';
            }
        }
        
        async function loadAllVouchers() {
            try {
                document.getElementById('vouchersLoading').style.display = 'block';
                document.getElementById('vouchersTable').style.display = 'none';
                
                const response = await apiCall(`${API_BASE}/vouchers`);
                const vouchers = await response.json();
                
                // Store all vouchers globally for filtering
                window.allVouchers = vouchers;
                applyVoucherFilter();
                
            } catch (error) {
                console.error('Error loading vouchers:', error);
                document.getElementById('vouchersLoading').textContent = 'Xatolik yuz berdi';
            }
        }
        
        function applyVoucherFilter() {
            if (!window.allVouchers) {
                return;
            }
            
            const statusFilter = document.getElementById('voucherStatusFilter').value;
            const typeFilter = document.getElementById('voucherTypeFilter').value;
            const searchTerm = document.getElementById('voucherSearch').value.toLowerCase();
            
            let filteredVouchers = window.allVouchers.filter(voucher => {
                // Status filter
                if (statusFilter && voucher.status !== statusFilter) {
                    return false;
                }
                
                // Type filter
                if (typeFilter && voucher.type !== typeFilter) {
                    return false;
                }
                
                // Search filter
                if (searchTerm) {
                    const searchString = `${voucher.code} ${voucher.userFullName} ${voucher.userTelegramId}`.toLowerCase();
                    if (!searchString.includes(searchTerm)) {
                        return false;
                    }
                }
                
                return true;
            });
            
            displayVouchers(filteredVouchers);
        }
        
        function displayVouchers(vouchers) {
            const tbody = document.getElementById('vouchersTableBody');
            tbody.innerHTML = '';
            
            // Show result count
            const resultText = vouchers.length === window.allVouchers?.length ? 
                `Jami: ${vouchers.length} ta voucher` : 
                `Ko'rsatilmoqda: ${vouchers.length} ta / Jami: ${window.allVouchers?.length || 0} ta voucher`;
            
            // Add result count display
            let resultCountDiv = document.getElementById('voucherResultCount');
            if (!resultCountDiv) {
                resultCountDiv = document.createElement('div');
                resultCountDiv.id = 'voucherResultCount';
                resultCountDiv.style.cssText = 'margin-bottom: 10px; font-size: 14px; color: #666; font-weight: 500;';
                document.getElementById('vouchersTable').parentNode.insertBefore(resultCountDiv, document.getElementById('vouchersTable'));
            }
            resultCountDiv.innerHTML = `<strong>${resultText}</strong>`;
            
            if (vouchers.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="9" style="text-align: center; padding: 20px; color: #666;">Hech qanday voucher topilmadi</td>';
                tbody.appendChild(row);
            } else {
                vouchers.forEach(voucher => {
                    const row = document.createElement('tr');
                    
                    const statusText = getVoucherStatusText(voucher.status);
                    const typeText = getVoucherTypeText(voucher.type);
                    const expiryInfo = voucher.status === 'ACTIVE' ? 
                        `${voucher.daysUntilExpiry} kun qoldi` : '';
                    
                    row.innerHTML = `
                        <td><strong>${voucher.code.toUpperCase()}</strong></td>
                        <td>${voucher.userFullName}<br><small>ID: ${voucher.userTelegramId}</small></td>
                        <td>${formatPrice(voucher.amount)} so'm</td>
                        <td>${typeText}</td>
                        <td>${statusText}<br><small>${expiryInfo}</small></td>
                        <td>${new Date(voucher.createdAt).toLocaleDateString('uz-UZ')}</td>
                        <td>${new Date(voucher.expiresAt).toLocaleDateString('uz-UZ')}</td>
                        <td>${voucher.usedAt ? new Date(voucher.usedAt).toLocaleDateString('uz-UZ') : '-'}</td>
                        <td>
                            ${voucher.status === 'ACTIVE' ? 
                                `<button class="btn" onclick="useVoucherFromTable('${voucher.code}')" style="background: #28a745; font-size: 12px; padding: 5px 10px;">Ishlatish</button>` : 
                                '-'
                            }
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            document.getElementById('vouchersLoading').style.display = 'none';
            document.getElementById('vouchersTable').style.display = 'table';
        }
        
        async function useVoucherFromTable(code) {
            document.getElementById('voucherCode').value = code;
            await useVoucher();
            // Reload vouchers to update the list
            await loadAllVouchers();
        }
        
        function getVoucherStatusText(status) {
            const statusMap = {
                'ACTIVE': '‚úÖ Faol',
                'USED': '‚úÖ Ishlatilgan',
                'EXPIRED': '‚ùå Muddati tugagan'
            };
            return statusMap[status] || status;
        }
        
        function getVoucherTypeText(type) {
            const typeMap = {
                'BIRTHDAY': 'üéÇ Tug\'ilgan kun',
                'ANNIVERSARY': 'üéâ Yubiley',
                'SPECIAL': '‚≠ê Maxsus'
            };
            return typeMap[type] || type;
        }
        
        // ========== CASHBACK FUNCTIONS ==========
        
        // Calculate cashback (5%)
        function calculateCashback() {
            const amount = document.getElementById('purchaseAmount').value;
            const calcDiv = document.getElementById('cashbackCalculation');
            
            if (amount && amount > 0) {
                const cashback = Math.round(amount * 0.05);
                calcDiv.textContent = `üí∞ Keshbek: ${formatPrice(cashback)} so'm (5%)`;
            } else {
                calcDiv.textContent = '';
            }
        }
        
        // Add purchase
        async function addPurchase() {
            const telegramId = document.getElementById('purchaseTelegramId').value.trim();
            const amount = document.getElementById('purchaseAmount').value.trim();
            const description = document.getElementById('purchaseDescription').value.trim() || 'Harid';
            const statusElement = document.getElementById('purchaseStatus');
            
            if (!telegramId || !amount) {
                alert('‚ùå Iltimos, Telegram ID va harid miqdorini kiriting!');
                return;
            }
            
            if (amount <= 0) {
                alert('‚ùå Harid miqdori 0 dan katta bo\'lishi kerak!');
                return;
            }
            
            try {
                statusElement.textContent = '‚è≥ Qo\'shilmoqda...';
                statusElement.style.color = '#007bff';
                
                const response = await apiCall(`${API_BASE}/cashback/add-purchase`, {
                    method: 'POST',
                    body: JSON.stringify({
                        telegramId: parseInt(telegramId),
                        purchaseAmount: parseInt(amount),
                        description: description
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    statusElement.textContent = `‚úÖ Muvaffaqiyatli! Keshbek: ${formatPrice(result.cashbackAmount)} so'm`;
                    statusElement.style.color = '#28a745';
                    
                    // Clear form
                    document.getElementById('purchaseTelegramId').value = '';
                    document.getElementById('purchaseAmount').value = '';
                    document.getElementById('purchaseDescription').value = '';
                    document.getElementById('cashbackCalculation').textContent = '';
                    
                    // Reload data
                    loadCashbackBalances();
                    loadCashbackHistory();
                    
                    alert(`‚úÖ Harid qo'shildi!\nKeshbek: ${formatPrice(result.cashbackAmount)} so'm`);
                } else {
                    const error = await response.text();
                    statusElement.textContent = '‚ùå Xatolik: ' + error;
                    statusElement.style.color = '#dc3545';
                }
            } catch (error) {
                console.error('Error adding purchase:', error);
                statusElement.textContent = '‚ùå Xatolik yuz berdi';
                statusElement.style.color = '#dc3545';
            }
        }
        
        // Load cashback balances
        async function loadCashbackBalances() {
            try {
                document.getElementById('balancesLoading').style.display = 'block';
                document.getElementById('balancesTable').style.display = 'none';
                
                const response = await apiCall(`${API_BASE}/cashback/all-balances`);
                const balances = await response.json();
                
                // Store globally for pagination
                window.allCashbackBalances = balances;
                currentBalancePage = 1;
                displayCashbackBalances(balances);
                
            } catch (error) {
                console.error('Error loading cashback balances:', error);
                document.getElementById('balancesLoading').textContent = 'Xatolik yuz berdi';
            }
        }
        
        function displayCashbackBalances(balances) {
            const tbody = document.getElementById('balancesTableBody');
            tbody.innerHTML = '';
            
            if (balances.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="6" style="text-align: center; padding: 20px; color: #666;">Hech qanday ma\'lumot yo\'q</td>';
                tbody.appendChild(row);
                document.getElementById('balancesLoading').style.display = 'none';
                document.getElementById('balancesTable').style.display = 'table';
                
                // Hide pagination
                let paginationDiv = document.getElementById('balancePagination');
                if (paginationDiv) paginationDiv.style.display = 'none';
                return;
            }
            
            // Calculate pagination
            const totalPages = Math.ceil(balances.length / ITEMS_PER_PAGE);
            const startIndex = (currentBalancePage - 1) * ITEMS_PER_PAGE;
            const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, balances.length);
            const paginatedBalances = balances.slice(startIndex, endIndex);
            
            paginatedBalances.forEach(balance => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${balance.telegramId}</td>
                    <td>${balance.fullName || '-'}</td>
                    <td>${balance.phoneNumber || '-'}</td>
                    <td><strong style="color: #28a745;">${formatPrice(balance.currentBalance)} so'm</strong></td>
                    <td>${formatPrice(balance.totalEarned)} so'm</td>
                    <td>${formatPrice(balance.totalUsed)} so'm</td>
                `;
                tbody.appendChild(row);
            });
            
            document.getElementById('balancesLoading').style.display = 'none';
            document.getElementById('balancesTable').style.display = 'table';
            
            // Add pagination controls
            renderBalancePagination(totalPages, balances.length, startIndex, endIndex);
        }
        
        function renderBalancePagination(totalPages, totalItems, startIndex, endIndex) {
            let paginationDiv = document.getElementById('balancePagination');
            if (!paginationDiv) {
                paginationDiv = document.createElement('div');
                paginationDiv.id = 'balancePagination';
                paginationDiv.className = 'pagination';
                document.getElementById('balancesTable').parentNode.appendChild(paginationDiv);
            }
            
            if (totalPages <= 1) {
                paginationDiv.style.display = 'none';
                return;
            }
            
            paginationDiv.style.display = 'flex';
            paginationDiv.innerHTML = `
                <button onclick="changeBalancePage(1)" ${currentBalancePage === 1 ? 'disabled' : ''}>‚èÆÔ∏è Birinchi</button>
                <button onclick="changeBalancePage(${currentBalancePage - 1})" ${currentBalancePage === 1 ? 'disabled' : ''}>‚óÄÔ∏è Oldingi</button>
                <span class="pagination-info">${startIndex + 1}-${endIndex} / ${totalItems}</span>
                <button onclick="changeBalancePage(${currentBalancePage + 1})" ${currentBalancePage === totalPages ? 'disabled' : ''}>Keyingi ‚ñ∂Ô∏è</button>
                <button onclick="changeBalancePage(${totalPages})" ${currentBalancePage === totalPages ? 'disabled' : ''}>Oxirgi ‚è≠Ô∏è</button>
            `;
        }
        
        function changeBalancePage(page) {
            currentBalancePage = page;
            displayCashbackBalances(window.allCashbackBalances);
        }
        
        // Load cashback history
        async function loadCashbackHistory() {
            try {
                document.getElementById('historyLoading').style.display = 'block';
                document.getElementById('historyTable').style.display = 'none';
                
                const response = await apiCall(`${API_BASE}/cashback/all-history`);
                const history = await response.json();
                
                // Store globally for filtering
                window.allCashbackHistory = history;
                applyCashbackHistoryFilter();
                
            } catch (error) {
                console.error('Error loading cashback history:', error);
                document.getElementById('historyLoading').textContent = 'Xatolik yuz berdi';
            }
        }
        
        // Apply cashback history filter
        function applyCashbackHistoryFilter() {
            if (!window.allCashbackHistory) {
                return;
            }
            
            const typeFilter = document.getElementById('historyTypeFilter').value;
            const searchTerm = document.getElementById('historySearch').value.toLowerCase();
            
            let filtered = window.allCashbackHistory.filter(item => {
                // Type filter
                if (typeFilter && item.type !== typeFilter) {
                    return false;
                }
                
                // Search filter
                if (searchTerm) {
                    const searchString = `${item.telegramId} ${item.fullName} ${item.description}`.toLowerCase();
                    if (!searchString.includes(searchTerm)) {
                        return false;
                    }
                }
                
                return true;
            });
            
            // Don't reset page if we're just changing pages
            if (typeFilter !== window.lastHistoryTypeFilter || searchTerm !== window.lastHistorySearchTerm) {
                currentHistoryPage = 1;
            }
            window.lastHistoryTypeFilter = typeFilter;
            window.lastHistorySearchTerm = searchTerm;
            
            displayCashbackHistory(filtered);
        }
        
        // Display cashback history
        function displayCashbackHistory(history) {
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';
            
            if (history.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="6" style="text-align: center; padding: 20px; color: #666;">Hech qanday ma\'lumot yo\'q</td>';
                tbody.appendChild(row);
                document.getElementById('historyLoading').style.display = 'none';
                document.getElementById('historyTable').style.display = 'table';
                
                // Hide pagination
                let paginationDiv = document.getElementById('historyPagination');
                if (paginationDiv) paginationDiv.style.display = 'none';
                return;
            }
            
            // Calculate pagination
            const totalPages = Math.ceil(history.length / ITEMS_PER_PAGE);
            const startIndex = (currentHistoryPage - 1) * ITEMS_PER_PAGE;
            const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, history.length);
            const paginatedHistory = history.slice(startIndex, endIndex);
            
            paginatedHistory.forEach(item => {
                const row = document.createElement('tr');
                
                const typeText = getCashbackTypeText(item.type);
                const typeColor = item.type === 'EARNED' ? '#28a745' : item.type === 'USED' ? '#dc3545' : '#007bff';
                
                row.innerHTML = `
                    <td>${new Date(item.createdAt).toLocaleString('uz-UZ')}</td>
                    <td>${item.fullName}<br><small>ID: ${item.telegramId}</small></td>
                    <td><span style="color: ${typeColor}; font-weight: 600;">${typeText}</span></td>
                    <td>${item.purchaseAmount > 0 ? formatPrice(item.purchaseAmount) + ' so\'m' : '-'}</td>
                    <td><strong>${formatPrice(item.cashbackAmount)} so'm</strong></td>
                    <td>${item.description || '-'}</td>
                `;
                tbody.appendChild(row);
            });
            
            document.getElementById('historyLoading').style.display = 'none';
            document.getElementById('historyTable').style.display = 'table';
            
            // Add pagination controls
            renderHistoryPagination(totalPages, history.length, startIndex, endIndex);
        }
        
        function renderHistoryPagination(totalPages, totalItems, startIndex, endIndex) {
            let paginationDiv = document.getElementById('historyPagination');
            if (!paginationDiv) {
                paginationDiv = document.createElement('div');
                paginationDiv.id = 'historyPagination';
                paginationDiv.className = 'pagination';
                document.getElementById('historyTable').parentNode.appendChild(paginationDiv);
            }
            
            if (totalPages <= 1) {
                paginationDiv.style.display = 'none';
                return;
            }
            
            paginationDiv.style.display = 'flex';
            paginationDiv.innerHTML = `
                <button onclick="changeHistoryPage(1)" ${currentHistoryPage === 1 ? 'disabled' : ''}>‚èÆÔ∏è Birinchi</button>
                <button onclick="changeHistoryPage(${currentHistoryPage - 1})" ${currentHistoryPage === 1 ? 'disabled' : ''}>‚óÄÔ∏è Oldingi</button>
                <span class="pagination-info">${startIndex + 1}-${endIndex} / ${totalItems}</span>
                <button onclick="changeHistoryPage(${currentHistoryPage + 1})" ${currentHistoryPage === totalPages ? 'disabled' : ''}>Keyingi ‚ñ∂Ô∏è</button>
                <button onclick="changeHistoryPage(${totalPages})" ${currentHistoryPage === totalPages ? 'disabled' : ''}>Oxirgi ‚è≠Ô∏è</button>
            `;
        }
        
        function changeHistoryPage(page) {
            currentHistoryPage = page;
            applyCashbackHistoryFilter();
        }
        
        // Use cashback
        async function useCashback() {
            const telegramId = document.getElementById('actionTelegramId').value.trim();
            const amount = document.getElementById('actionAmount').value.trim();
            const description = document.getElementById('actionDescription').value.trim() || 'Keshbek ishlatildi';
            const statusElement = document.getElementById('actionStatus');
            
            if (!telegramId || !amount) {
                alert('‚ùå Iltimos, Telegram ID va miqdorni kiriting!');
                return;
            }
            
            if (amount <= 0) {
                alert('‚ùå Miqdor 0 dan katta bo\'lishi kerak!');
                return;
            }
            
            if (!confirm(`Haqiqatan ham ${formatPrice(amount)} so'm keshbekni ishlatishni xohlaysizmi?`)) {
                return;
            }
            
            try {
                statusElement.textContent = '‚è≥ Ishlanmoqda...';
                statusElement.style.color = '#007bff';
                
                const response = await apiCall(`${API_BASE}/cashback/use`, {
                    method: 'POST',
                    body: JSON.stringify({
                        telegramId: parseInt(telegramId),
                        amount: parseInt(amount),
                        description: description
                    })
                });
                
                if (response.ok) {
                    statusElement.textContent = '‚úÖ Keshbek muvaffaqiyatli ishlatildi!';
                    statusElement.style.color = '#28a745';
                    
                    // Clear form
                    document.getElementById('actionTelegramId').value = '';
                    document.getElementById('actionAmount').value = '';
                    document.getElementById('actionDescription').value = '';
                    
                    // Reload data
                    loadCashbackBalances();
                    loadCashbackHistory();
                    
                    alert('‚úÖ Keshbek muvaffaqiyatli ishlatildi!');
                } else {
                    const error = await response.text();
                    statusElement.textContent = '‚ùå Xatolik: ' + error;
                    statusElement.style.color = '#dc3545';
                    alert('‚ùå Xatolik: ' + error);
                }
            } catch (error) {
                console.error('Error using cashback:', error);
                statusElement.textContent = '‚ùå Xatolik yuz berdi';
                statusElement.style.color = '#dc3545';
            }
        }
        
        // Refund cashback
        async function refundCashback() {
            const telegramId = document.getElementById('actionTelegramId').value.trim();
            const amount = document.getElementById('actionAmount').value.trim();
            const description = document.getElementById('actionDescription').value.trim() || 'Keshbek qaytarildi';
            const statusElement = document.getElementById('actionStatus');
            
            if (!telegramId || !amount) {
                alert('‚ùå Iltimos, Telegram ID va miqdorni kiriting!');
                return;
            }
            
            if (amount <= 0) {
                alert('‚ùå Miqdor 0 dan katta bo\'lishi kerak!');
                return;
            }
            
            if (!confirm(`Haqiqatan ham ${formatPrice(amount)} so'm keshbekni qaytarishni xohlaysizmi?`)) {
                return;
            }
            
            try {
                statusElement.textContent = '‚è≥ Ishlanmoqda...';
                statusElement.style.color = '#007bff';
                
                const response = await apiCall(`${API_BASE}/cashback/refund`, {
                    method: 'POST',
                    body: JSON.stringify({
                        telegramId: parseInt(telegramId),
                        amount: parseInt(amount),
                        description: description
                    })
                });
                
                if (response.ok) {
                    statusElement.textContent = '‚úÖ Keshbek muvaffaqiyatli qaytarildi!';
                    statusElement.style.color = '#28a745';
                    
                    // Clear form
                    document.getElementById('actionTelegramId').value = '';
                    document.getElementById('actionAmount').value = '';
                    document.getElementById('actionDescription').value = '';
                    
                    // Reload data
                    loadCashbackBalances();
                    loadCashbackHistory();
                    
                    alert('‚úÖ Keshbek muvaffaqiyatli qaytarildi!');
                } else {
                    const error = await response.text();
                    statusElement.textContent = '‚ùå Xatolik: ' + error;
                    statusElement.style.color = '#dc3545';
                    alert('‚ùå Xatolik: ' + error);
                }
            } catch (error) {
                console.error('Error refunding cashback:', error);
                statusElement.textContent = '‚ùå Xatolik yuz berdi';
                statusElement.style.color = '#dc3545';
            }
        }
        
        // Get cashback type text
        function getCashbackTypeText(type) {
            const typeMap = {
                'EARNED': '‚ûï Olingan',
                'USED': '‚ûñ Ishlatilgan',
                'REFUNDED': '‚Ü©Ô∏è Qaytarilgan'
            };
            return typeMap[type] || type;
        }
        
        // Load cashback data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadCashbackBalances();
            loadCashbackHistory();
        });
    </script>
</body>
</html>