<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kupon Bot - Admin Panel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #666;
            font-size: 1.1em;
        }
        
        .section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #555;
        }
        
        .table tr:hover {
            background-color: #f8f9fa;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn:hover {
            background: #5a6fd8;
        }
        
        .search-box {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 16px;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        
        .form-grid {
            display: grid;
            gap: 10px;
            margin-top: 15px;
        }
        
        .form-grid input,
        .form-grid textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-grid textarea {
            height: 80px;
            resize: vertical;
        }
        
        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .add-product-form {
            display: none;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }
        
        .date-highlight {
            background: transparent;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: normal;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>üõí Ko'zoynak Do'koni - Admin Panel</h1>
                    <p>Mahsulotlar va buyurtmalarni boshqarish</p>
                </div>
                <div>
                    <button onclick="logout()" style="
                        background: #dc3545;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 5px;
                        cursor: pointer;
                        font-size: 14px;
                    ">Chiqish</button>
                </div>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalUsers">-</div>
                <div class="stat-label">Jami foydalanuvchilar</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalProducts">-</div>
                <div class="stat-label">Jami mahsulotlar</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalOrders">-</div>
                <div class="stat-label">Jami buyurtmalar</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalCoupons">-</div>
                <div class="stat-label">Jami kuponlar</div>
            </div>
        </div>
        
        <div class="section">
            <h2 class="section-title">üõí Mahsulotlar</h2>
            <div style="margin-bottom: 20px;">
                <button class="btn" onclick="showAddProductForm()" style="background: #28a745;">+ Yangi mahsulot</button>
            </div>
            
            <div id="addProductForm" class="add-product-form">
                <h3>Yangi mahsulot qo'shish</h3>
                <div class="form-grid">
                    <input type="text" id="productName" placeholder="Mahsulot nomi *" required>
                    <textarea id="productDescription" placeholder="Tavsif"></textarea>
                    <input type="number" id="productPrice" placeholder="Narxi (so'm) *" required>
                    <input type="url" id="productImageUrl" placeholder="Rasm URL (ixtiyoriy)">
                    <input type="number" id="productStock" placeholder="Stok miqdori *" required>
                </div>
                <div class="form-buttons">
                    <button class="btn" onclick="addProduct()" style="background: #28a745;">Qo'shish</button>
                    <button class="btn" onclick="hideAddProductForm()" style="background: #6c757d;">Bekor qilish</button>
                </div>
            </div>
            
            <input type="text" class="search-box" id="productSearch" placeholder="Mahsulot qidirish...">
            <div id="productsLoading" class="loading">Ma'lumotlar yuklanmoqda...</div>
            <table class="table" id="productsTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Rasm</th>
                        <th>Nomi</th>
                        <th>Narxi</th>
                        <th>Stok</th>
                        <th>Holat</th>
                        <th>Amal</th>
                    </tr>
                </thead>
                <tbody id="productsTableBody">
                </tbody>
            </table>
        </div>
        

        
        <div class="section">
            <h2 class="section-title">üë• Foydalanuvchilar</h2>
            
            <!-- Filter Section -->
            <div style="background: #dbeafe; border: 2px dashed #3b82f6; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                <div style="display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap;">
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <label style="font-size: 13px; font-weight: 600; color: #1e40af;">Yil</label>
                        <select id="yearFilter" style="padding: 10px 16px; border: 2px solid #60a5fa; border-radius: 6px; font-size: 14px; background: white; color: #333; min-width: 140px; cursor: pointer;">
                            <option value="">Yilni tanlang</option>
                        </select>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <label style="font-size: 13px; font-weight: 600; color: #1e40af;">Oy</label>
                        <select id="monthFilter" style="padding: 10px 16px; border: 2px solid #60a5fa; border-radius: 6px; font-size: 14px; background: white; color: #333; min-width: 160px; cursor: pointer;">
                            <option value="">Oyni tanlang</option>
                            <option value="01">01 - Yanvar</option>
                            <option value="02">02 - Fevral</option>
                            <option value="03">03 - Mart</option>
                            <option value="04">04 - Aprel</option>
                            <option value="05">05 - May</option>
                            <option value="06">06 - Iyun</option>
                            <option value="07">07 - Iyul</option>
                            <option value="08">08 - Avgust</option>
                            <option value="09">09 - Sentabr</option>
                            <option value="10">10 - Oktabr</option>
                            <option value="11">11 - Noyabr</option>
                            <option value="12">12 - Dekabr</option>
                        </select>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <label style="font-size: 13px; font-weight: 600; color: #1e40af;">Kun</label>
                        <select id="dayFilter" style="padding: 10px 16px; border: 2px solid #60a5fa; border-radius: 6px; font-size: 14px; background: white; color: #333; min-width: 100px; cursor: pointer;">
                            <option value="">Kunni tanlang</option>
                            <option value="01">01</option>
                            <option value="02">02</option>
                            <option value="03">03</option>
                            <option value="04">04</option>
                            <option value="05">05</option>
                            <option value="06">06</option>
                            <option value="07">07</option>
                            <option value="08">08</option>
                            <option value="09">09</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                            <option value="13">13</option>
                            <option value="14">14</option>
                            <option value="15">15</option>
                            <option value="16">16</option>
                            <option value="17">17</option>
                            <option value="18">18</option>
                            <option value="19">19</option>
                            <option value="20">20</option>
                            <option value="21">21</option>
                            <option value="22">22</option>
                            <option value="23">23</option>
                            <option value="24">24</option>
                            <option value="25">25</option>
                            <option value="26">26</option>
                            <option value="27">27</option>
                            <option value="28">28</option>
                            <option value="29">29</option>
                            <option value="30">30</option>
                            <option value="31">31</option>
                        </select>
                    </div>
                    <button onclick="applyDateFilter()" style="padding: 10px 24px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; height: 42px;">üîç Filtrni qo'llash</button>
                    <button onclick="resetDateFilter()" style="padding: 10px 24px; background: #6b7280; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; height: 42px;">üîÑ Tozalash</button>
                    <button onclick="exportFilteredUsers()" style="padding: 10px 24px; background: #10b981; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; height: 42px; margin-left: 10px;">üìä Excelda yuklab olish</button>
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div style="font-size: 14px; color: #666; font-weight: 500;" id="userResultCount">Jami: <strong>0</strong> ta foydalanuvchi</div>
                <input type="text" class="search-box" id="userSearch" placeholder="Qidirish..." style="max-width: 300px; margin: 0;">
            </div>
            
            <div id="usersLoading" class="loading">Ma'lumotlar yuklanmoqda...</div>
            <table class="table" id="usersTable" style="display: none;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Ism</th>
                        <th>Familiya</th>
                        <th>Username</th>
                        <th>Telefon</th>
                        <th>Tug'ilgan kun</th>
                        <th>Holat</th>
                        <th>Ro'yxatdan o'tgan</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                </tbody>
            </table>
        </div>
        
        <div class="section">
            <h2 class="section-title">üì¢ Barcha foydalanuvchilarga xabar</h2>
            <div style="margin-bottom: 20px;">
                <textarea id="broadcastMessage" placeholder="Barcha foydalanuvchilarga yuboriladigan xabar..." 
                    style="width: 100%; height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; resize: vertical;"></textarea>
                <div style="margin-top: 10px;">
                    <button class="btn" onclick="sendBroadcast()" style="background: #dc3545;">üì¢ Barcha foydalanuvchilarga yuborish</button>
                    <span id="broadcastStatus" style="margin-left: 15px; font-weight: bold;"></span>
                </div>
                <p style="margin-top: 10px; color: #666; font-size: 14px;">
                    ‚ö†Ô∏è Bu xabar barcha ro'yxatdan o'tgan foydalanuvchilarga yuboriladi. Ehtiyot bo'ling!
                </p>
            </div>
        </div>
        
        <div class="section">
            <h2 class="section-title">üë§ Bitta foydalanuvchiga xabar</h2>
            <div style="margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 15px; margin-bottom: 15px;">
                    <input type="number" id="singleUserId" placeholder="Telegram ID (masalan: 123456789)" 
                        style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                    <textarea id="singleUserMessage" placeholder="Foydalanuvchiga yuboriladigan xabar..." 
                        style="height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; resize: vertical;"></textarea>
                </div>
                <div style="margin-top: 10px;">
                    <button class="btn" onclick="sendSingleMessage()" style="background: #007bff;">üë§ Xabar yuborish</button>
                    <button class="btn" onclick="findUserById()" style="background: #28a745; margin-left: 10px;">üîç Foydalanuvchini topish</button>
                    <span id="singleMessageStatus" style="margin-left: 15px; font-weight: bold;"></span>
                </div>
                <div id="foundUserInfo" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; display: none;">
                    <h4>Topilgan foydalanuvchi:</h4>
                    <div id="userDetails"></div>
                </div>
                <p style="margin-top: 10px; color: #666; font-size: 14px;">
                    üí° Foydalanuvchining Telegram ID sini kiritib, unga shaxsiy xabar yuboring. Avval "Foydalanuvchini topish" tugmasini bosib, to'g'ri foydalanuvchi ekanligini tekshiring.
                </p>
            </div>
        </div>
        
        <div class="section">
            <h2 class="section-title">üîî Bildirishnomalar</h2>
            <div style="margin-bottom: 20px;">
                <button class="btn" onclick="testNotifications()" style="background: #17a2b8;">üìß Test xabar yuborish</button>
                <button class="btn" onclick="testAnniversary()" style="background: #28a745; margin-left: 10px;">üéâ 6 oylik yubiley test</button>
                <button class="btn" onclick="testBirthdays()" style="background: #ffc107; margin-left: 10px;">üéÇ Tug'ilgan kun test</button>
                <button class="btn" onclick="testThreeMinute()" style="background: #dc3545; margin-left: 10px;">‚è∞ 3 daqiqa test</button>
                <p style="margin-top: 10px; color: #666; font-size: 14px;">
                    Bu tugmalar admin'ga test xabarlar yuboradi. Avtomatik xabarlar har kuni soat 09:00 (6 oylik yubiley) va 10:00 (tug'ilgan kunlar) da yuboriladi. 3 daqiqa test har daqiqada tekshiriladi.
                </p>
            </div>
        </div>
    </div>

    <script>
        // Check authentication first
        if (localStorage.getItem('adminAuth') !== 'true') {
            window.location.href = '/login.html';
        }
        
        // API base URL (Local development)
        const API_BASE = '/api/admin';
        
        // Store all users and filtered users
        let allUsers = [];
        let filteredUsers = [];
        
        // Helper function for API calls with bypass headers
        async function apiCall(url, options = {}) {
            const defaultHeaders = {
                'bypass-tunnel-reminder': 'true',
                'User-Agent': 'KuponBot-Admin/1.0',
                'Content-Type': 'application/json'
            };
            
            const mergedOptions = {
                ...options,
                headers: {
                    ...defaultHeaders,
                    ...options.headers
                }
            };
            
            return fetch(url, mergedOptions);
        }
        
        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadProducts();
            loadUsers();
            populateYearFilter(); // Yil filtrini avtomatik to'ldirish
        });
        
        // Populate year filter dynamically
        function populateYearFilter() {
            const yearSelect = document.getElementById('yearFilter');
            const currentYear = new Date().getFullYear();
            const startYear = 2020; // Boshlang'ich yil
            
            // Joriy yildan boshlab 2020 yilgacha
            for (let year = currentYear; year >= startYear; year--) {
                const option = document.createElement('option');
                option.value = year.toString();
                option.textContent = year.toString();
                yearSelect.appendChild(option);
            }
        }
        
        // Load statistics
        async function loadStats() {
            try {
                const response = await apiCall(`${API_BASE}/stats`);
                const stats = await response.json();
                
                document.getElementById('totalUsers').textContent = stats.totalUsers;
                document.getElementById('totalProducts').textContent = stats.totalProducts;
                document.getElementById('totalOrders').textContent = stats.totalOrders;
                document.getElementById('totalCoupons').textContent = stats.totalCoupons;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        // Show add product form
        function showAddProductForm() {
            const form = document.getElementById('addProductForm');
            if (form) {
                form.style.display = 'block';
            }
        }
        
        // Hide add product form
        function hideAddProductForm() {
            document.getElementById('addProductForm').style.display = 'none';
            // Clear form
            document.getElementById('productName').value = '';
            document.getElementById('productDescription').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productImageUrl').value = '';
            document.getElementById('productStock').value = '';
        }
        
        // Add product
        async function addProduct() {
            const name = document.getElementById('productName').value;
            const description = document.getElementById('productDescription').value;
            const price = document.getElementById('productPrice').value;
            const imageUrl = document.getElementById('productImageUrl').value;
            const stockQuantity = document.getElementById('productStock').value;
            
            if (!name || !price || !stockQuantity) {
                alert('Iltimos, majburiy maydonlarni to\'ldiring (*, narx, stok)');
                return;
            }
            
            try {
                const response = await apiCall(`${API_BASE}/products`, {
                    method: 'POST',
                    body: JSON.stringify({
                        name: name,
                        description: description,
                        price: price,
                        imageUrl: imageUrl,
                        stockQuantity: parseInt(stockQuantity)
                    })
                });
                
                if (response.ok) {
                    alert('Mahsulot muvaffaqiyatli qo\'shildi!');
                    hideAddProductForm();
                    loadStats();
                    loadProducts();
                } else {
                    alert('Xatolik yuz berdi!');
                }
            } catch (error) {
                console.error('Error adding product:', error);
                alert('Xatolik yuz berdi!');
            }
        }
        
        // Load products
        async function loadProducts() {
            try {
                const response = await apiCall(`${API_BASE}/products`);
                const products = await response.json();
                
                const tbody = document.getElementById('productsTableBody');
                tbody.innerHTML = '';
                
                products.forEach(product => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            ${product.imageUrl ? 
                                `<img src="${product.imageUrl}" alt="${product.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">` : 
                                'üëì'
                            }
                        </td>
                        <td>${product.name}</td>
                        <td>${formatPrice(product.price)} so'm</td>
                        <td>${product.stockQuantity}</td>
                        <td>${product.status === 'ACTIVE' ? '‚úÖ Faol' : '‚ùå Nofaol'}</td>
                        <td>
                            <button class="btn" onclick="deleteProduct(${product.id})" style="background: #dc3545; font-size: 12px; padding: 5px 10px;">O'chirish</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                document.getElementById('productsLoading').style.display = 'none';
                document.getElementById('productsTable').style.display = 'table';
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('productsLoading').textContent = 'Xatolik yuz berdi';
            }
        }
        
        // Delete product
        async function deleteProduct(id) {
            if (!confirm('Bu mahsulotni o\'chirish tasdiqlaysizmi?')) {
                return;
            }
            
            try {
                const response = await apiCall(`${API_BASE}/products/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('Mahsulot o\'chirildi!');
                    loadStats();
                    loadProducts();
                } else {
                    alert('Xatolik yuz berdi!');
                }
            } catch (error) {
                console.error('Error deleting product:', error);
                alert('Xatolik yuz berdi!');
            }
        }
        

        
        // Load users
        async function loadUsers(filter = 'all') {
            try {
                let url = `${API_BASE}/users`;
                if (filter !== 'all') {
                    url = `${API_BASE}/users-filtered?filter=${filter}`;
                }
                
                const response = await apiCall(url);
                const users = await response.json();
                
                allUsers = users;
                filteredUsers = [...users];
                displayUsers(filteredUsers);
                
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersLoading').textContent = 'Xatolik yuz berdi';
            }
        }
        
        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';
            
            const resultCount = document.getElementById('userResultCount');
            resultCount.innerHTML = `Jami: <strong>${users.length}</strong> ta foydalanuvchi`;
            
            users.forEach(user => {
                const row = document.createElement('tr');
                
                // Parse createdAt date
                const createdDate = new Date(user.createdAt);
                const formattedDate = `${String(createdDate.getDate()).padStart(2, '0')}/${String(createdDate.getMonth() + 1).padStart(2, '0')}/${createdDate.getFullYear()}`;
                
                row.innerHTML = `
                    <td>${user.telegramId}</td>
                    <td>${user.firstName || '-'}</td>
                    <td>${user.lastName || '-'}</td>
                    <td>${user.telegramUsername || 'Username yo\'q'}</td>
                    <td>${user.phoneNumber || '-'}</td>
                    <td>${user.birthDate || 'Kiritilmagan'}</td>
                    <td>${user.state}</td>
                    <td><span class="date-highlight">${formattedDate}</span></td>
                `;
                tbody.appendChild(row);
            });
            
            document.getElementById('usersLoading').style.display = 'none';
            document.getElementById('usersTable').style.display = 'table';
        }
        
        // Apply date filter
        function applyDateFilter() {
            const year = document.getElementById('yearFilter').value;
            const month = document.getElementById('monthFilter').value;
            const day = document.getElementById('dayFilter').value;
            
            if (!year && !month && !day) {
                alert('Iltimos, kamida bitta filtrni tanlang!');
                return;
            }
            
            filteredUsers = allUsers.filter(user => {
                const createdDate = new Date(user.createdAt);
                const userDay = String(createdDate.getDate()).padStart(2, '0');
                const userMonth = String(createdDate.getMonth() + 1).padStart(2, '0');
                const userYear = createdDate.getFullYear().toString();
                
                let match = true;
                if (year && userYear !== year) match = false;
                if (month && userMonth !== month) match = false;
                if (day && userDay !== day) match = false;
                
                return match;
            });
            
            displayUsers(filteredUsers);
        }
        
        // Reset date filter
        function resetDateFilter() {
            document.getElementById('yearFilter').value = '';
            document.getElementById('monthFilter').value = '';
            document.getElementById('dayFilter').value = '';
            filteredUsers = [...allUsers];
            displayUsers(filteredUsers);
        }
        
        // Export filtered users to Excel
        function exportFilteredUsers() {
            if (filteredUsers.length === 0) {
                alert('Eksport qilish uchun ma\'lumot yo\'q!');
                return;
            }
            
            // Prepare data
            const data = [
                ['ID', 'Ism', 'Familiya', 'Username', 'Telefon', 'Tug\'ilgan kun', 'Holat', 'Ro\'yxatdan o\'tgan']
            ];
            
            filteredUsers.forEach(user => {
                const createdDate = new Date(user.createdAt);
                const formattedDate = `${String(createdDate.getDate()).padStart(2, '0')}/${String(createdDate.getMonth() + 1).padStart(2, '0')}/${createdDate.getFullYear()}`;
                
                data.push([
                    user.telegramId,
                    user.firstName || '-',
                    user.lastName || '-',
                    user.telegramUsername || 'Username yo\'q',
                    user.phoneNumber || '-',
                    user.birthDate || 'Kiritilmagan',
                    user.state,
                    formattedDate
                ]);
            });
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Set column widths
            ws['!cols'] = [
                { wch: 12 }, // ID
                { wch: 15 }, // Ism
                { wch: 15 }, // Familiya
                { wch: 18 }, // Username
                { wch: 15 }, // Telefon
                { wch: 15 }, // Tug'ilgan kun
                { wch: 12 }, // Holat
                { wch: 18 }  // Ro'yxatdan o'tgan
            ];
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Foydalanuvchilar');
            
            // Generate filename
            const today = new Date();
            const filename = `foydalanuvchilar_${today.getFullYear()}_${String(today.getMonth()+1).padStart(2,'0')}_${String(today.getDate()).padStart(2,'0')}.xlsx`;
            
            // Save file
            XLSX.writeFile(wb, filename);
        }
        
        // Helper functions
        function formatPrice(price) {
            return new Intl.NumberFormat('uz-UZ').format(price);
        }
        
        function getOrderStatusText(status) {
            const statusMap = {
                'PENDING': '‚è≥ Kutilmoqda',
                'CONFIRMED': '‚úÖ Tasdiqlangan',
                'PREPARING': 'üîÑ Tayyorlanmoqda',
                'SHIPPED': 'üöö Yuborilgan',
                'DELIVERED': '‚úÖ Yetkazilgan',
                'CANCELLED': '‚ùå Bekor qilingan'
            };
            return statusMap[status] || status;
        }
        
        // Logout function
        function logout() {
            if (confirm('Admin paneldan chiqishni xohlaysizmi?')) {
                localStorage.removeItem('adminAuth');
                window.location.href = '/login.html';
            }
        }
        
        // Search functionality
        document.getElementById('productSearch').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#productsTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });
        

        
        document.getElementById('userSearch').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            
            if (!searchTerm) {
                displayUsers(filteredUsers);
                return;
            }
            
            const searchResults = filteredUsers.filter(user => {
                const searchString = `${user.telegramId} ${user.firstName} ${user.lastName} ${user.telegramUsername} ${user.phoneNumber}`.toLowerCase();
                return searchString.includes(searchTerm);
            });
            
            displayUsers(searchResults);
        });
        
        // Test notifications function
        async function testNotifications() {
            try {
                const response = await apiCall(`${API_BASE}/test-notifications`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('‚úÖ Test xabar muvaffaqiyatli yuborildi!');
                } else {
                    alert('‚ùå Xatolik yuz berdi: ' + response.statusText);
                }
            } catch (error) {
                console.error('Error testing notifications:', error);
                alert('‚ùå Xatolik yuz berdi: ' + error.message);
            }
        }
        
        // Test anniversary function
        async function testAnniversary() {
            try {
                const response = await apiCall(`${API_BASE}/test-anniversary`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('‚úÖ 6 oylik yubiley test muvaffaqiyatli bajarildi!');
                } else {
                    alert('‚ùå Xatolik yuz berdi: ' + response.statusText);
                }
            } catch (error) {
                console.error('Error testing anniversary:', error);
                alert('‚ùå Xatolik yuz berdi: ' + error.message);
            }
        }
        
        // Test birthdays function
        async function testBirthdays() {
            try {
                const response = await apiCall(`${API_BASE}/test-birthdays`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('‚úÖ Tug\'ilgan kun test muvaffaqiyatli bajarildi!');
                } else {
                    alert('‚ùå Xatolik yuz berdi: ' + response.statusText);
                }
            } catch (error) {
                console.error('Error testing birthdays:', error);
                alert('‚ùå Xatolik yuz berdi: ' + error.message);
            }
        }
        
        // Test 3-minute registration function
        async function testThreeMinute() {
            try {
                const response = await apiCall(`${API_BASE}/test-3minute`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('‚úÖ 3 daqiqa test muvaffaqiyatli bajarildi!');
                } else {
                    alert('‚ùå Xatolik yuz berdi: ' + response.statusText);
                }
            } catch (error) {
                console.error('Error testing 3-minute:', error);
                alert('‚ùå Xatolik yuz berdi: ' + error.message);
            }
        }
        
        // Send broadcast message
        async function sendBroadcast() {
            const message = document.getElementById('broadcastMessage').value.trim();
            const statusElement = document.getElementById('broadcastStatus');
            
            if (!message) {
                alert('‚ùå Iltimos, xabar matnini kiriting!');
                return;
            }
            
            if (!confirm('Haqiqatan ham barcha foydalanuvchilarga xabar yuborishni xohlaysizmi?')) {
                return;
            }
            
            try {
                statusElement.textContent = 'üì§ Yuborilmoqda...';
                statusElement.style.color = '#007bff';
                
                const response = await apiCall(`${API_BASE}/broadcast`, {
                    method: 'POST',
                    body: JSON.stringify({ message: message })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    statusElement.innerHTML = `
                        ‚úÖ Yuborildi: ${result.successCount}/${result.totalUsers} 
                        (${result.successRate.toFixed(1)}%)
                        ${result.failureCount > 0 ? `‚ùå Xatolik: ${result.failureCount}` : ''}
                    `;
                    statusElement.style.color = '#28a745';
                    
                    // Clear message after successful send
                    document.getElementById('broadcastMessage').value = '';
                    
                    alert(`‚úÖ Xabar muvaffaqiyatli yuborildi!\n\nJami: ${result.totalUsers}\nMuvaffaqiyatli: ${result.successCount}\nXatolik: ${result.failureCount}`);
                } else {
                    statusElement.textContent = '‚ùå Xatolik yuz berdi';
                    statusElement.style.color = '#dc3545';
                    alert('‚ùå Xatolik yuz berdi: ' + response.statusText);
                }
            } catch (error) {
                console.error('Error sending broadcast:', error);
                statusElement.textContent = '‚ùå Xatolik yuz berdi';
                statusElement.style.color = '#dc3545';
                alert('‚ùå Xatolik yuz berdi: ' + error.message);
            }
        }
        
        // Find user by Telegram ID
        async function findUserById() {
            const telegramId = document.getElementById('singleUserId').value.trim();
            const statusElement = document.getElementById('singleMessageStatus');
            const userInfoDiv = document.getElementById('foundUserInfo');
            const userDetailsDiv = document.getElementById('userDetails');
            
            if (!telegramId) {
                alert('‚ùå Iltimos, Telegram ID ni kiriting!');
                return;
            }
            
            try {
                statusElement.textContent = 'üîç Qidirilmoqda...';
                statusElement.style.color = '#007bff';
                userInfoDiv.style.display = 'none';
                
                const response = await apiCall(`${API_BASE}/find-user/${telegramId}`);
                
                if (response.ok) {
                    const user = await response.json();
                    statusElement.textContent = '‚úÖ Foydalanuvchi topildi!';
                    statusElement.style.color = '#28a745';
                    
                    // Display user info
                    userDetailsDiv.innerHTML = `
                        <p><strong>ID:</strong> ${user.telegramId}</p>
                        <p><strong>Ism:</strong> ${user.firstName || '-'}</p>
                        <p><strong>Familiya:</strong> ${user.lastName || '-'}</p>
                        <p><strong>Username:</strong> ${user.telegramUsername || 'Username yo\'q'}</p>
                        <p><strong>Telefon:</strong> ${user.phoneNumber || '-'}</p>
                        <p><strong>Tug\'ilgan kun:</strong> ${user.birthDate || 'Kiritilmagan'}</p>
                        <p><strong>Holat:</strong> ${user.state}</p>
                        <p><strong>Ro\'yxatdan o\'tgan:</strong> ${new Date(user.createdAt).toLocaleDateString('uz-UZ')}</p>
                    `;
                    userInfoDiv.style.display = 'block';
                    
                } else if (response.status === 404) {
                    statusElement.textContent = '‚ùå Foydalanuvchi topilmadi';
                    statusElement.style.color = '#dc3545';
                    userInfoDiv.style.display = 'none';
                } else {
                    statusElement.textContent = '‚ùå Xatolik yuz berdi';
                    statusElement.style.color = '#dc3545';
                    userInfoDiv.style.display = 'none';
                }
            } catch (error) {
                console.error('Error finding user:', error);
                statusElement.textContent = '‚ùå Xatolik yuz berdi';
                statusElement.style.color = '#dc3545';
                userInfoDiv.style.display = 'none';
            }
        }
        
        // Send message to single user
        async function sendSingleMessage() {
            const telegramId = document.getElementById('singleUserId').value.trim();
            const message = document.getElementById('singleUserMessage').value.trim();
            const statusElement = document.getElementById('singleMessageStatus');
            
            if (!telegramId) {
                alert('‚ùå Iltimos, Telegram ID ni kiriting!');
                return;
            }
            
            if (!message) {
                alert('‚ùå Iltimos, xabar matnini kiriting!');
                return;
            }
            
            if (!confirm(`Haqiqatan ham ${telegramId} ID li foydalanuvchiga xabar yuborishni xohlaysizmi?`)) {
                return;
            }
            
            try {
                statusElement.textContent = 'üì§ Yuborilmoqda...';
                statusElement.style.color = '#007bff';
                
                const response = await apiCall(`${API_BASE}/send-single-message`, {
                    method: 'POST',
                    body: JSON.stringify({ 
                        telegramId: telegramId,
                        message: message 
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    statusElement.textContent = '‚úÖ Xabar muvaffaqiyatli yuborildi!';
                    statusElement.style.color = '#28a745';
                    
                    // Clear message after successful send
                    document.getElementById('singleUserMessage').value = '';
                    
                    alert('‚úÖ Xabar muvaffaqiyatli yuborildi!');
                } else if (response.status === 404) {
                    statusElement.textContent = '‚ùå Foydalanuvchi topilmadi';
                    statusElement.style.color = '#dc3545';
                    alert('‚ùå Foydalanuvchi topilmadi yoki ro\'yxatdan o\'tmagan');
                } else {
                    statusElement.textContent = '‚ùå Xatolik yuz berdi';
                    statusElement.style.color = '#dc3545';
                    alert('‚ùå Xatolik yuz berdi: ' + response.statusText);
                }
            } catch (error) {
                console.error('Error sending single message:', error);
                statusElement.textContent = '‚ùå Xatolik yuz berdi';
                statusElement.style.color = '#dc3545';
                alert('‚ùå Xatolik yuz berdi: ' + error.message);
            }
        }
    </script>
</body>
</html>